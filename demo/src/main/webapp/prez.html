<!doctype html>
<html lang="en">

<head>
   <meta charset="utf-8">
   <title>ScalaCompilerDoMatter</title>
   <meta name="description" content="Presentation on Scala Compiler features">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

   <link rel="stylesheet" href="css/reveal.css">
   <link rel="stylesheet" href="css/extension.css">
   <link rel="stylesheet" href="css/theme/sky.css" id="theme">

   <!-- For syntax highlighting -->
   <link rel="stylesheet" href="lib/css/zenburn.css">

   <!-- If the query includes 'print-pdf', use the PDF print sheet -->
   <script>document.write('<link rel="stylesheet" href="css/print/'
      + (window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper')
      + '.css" type="text/css" media="print">');
   </script>

   <!--[if lt IE 9]>
      <script src="lib/js/html5shiv.js"></script>
   <![endif]-->
   <style type="text/css" media="screen">
	 #codecontent { 
            background: #E3E4FA;
            display: inline-block;
            width: 100%;
            height: 620px;
            margin:0;
            padding:0;
	    text-align:left;
	    font-family: 'Monaco','Menlo','Ubuntu Mono','Consolas','source-code-pro',monospace;
         }

#codecontent .ace_cursor {
  border-left: 2px solid black;
}
 
      </style>
</head>

<body>
  <div class="reveal">
    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
      <section>
        <h2>Scala Compiler plugins</h2>
        <hr />
        <h3>Why they matter!</h3>
      </section>
      <section>
         <section>
            <h3>Let's start with a simple exemple</h3>
      	    <hr />
	 </section>
         <section>
            <h3>Let's consider that Java Code</h3>
	    <hr />
<pre><code>
public class ImmutableClass {
   private String field1;
   private int    field2;

   public ImmutableClass(String f1, int f2) {
      field1 = f1;
      field2 = f2;
   }

   public String getField1() { return field1; }
   public int getField2()    { return field2; }
}

</code></pre>
Pffeeeew ... much code
	 </section>
         <section>
            <h3>Let's make it simpler</h3>
	    <hr />
<pre><code>
@Immutable class ImmutableClass {
   String field1;
   int    field2;
}

</code></pre>
Ok much better, thanks to Metaprogramming/AST in Groovy
	 </section>
         <section>
            <h3>Ok ... in Scala there are classes ;)</h3>
	    <hr />
<pre><code>
class ImmutableClass(val String field1, val Int field2)

</code></pre>
	 </section>
      </section>
      <section>
        <h1>Agenda</h1>
        <hr />
	<ol>
	  <li>Introduction</li>
          <li>Plumbing</li>
	  <li>Visiting the AST</li>
	  <li>Altering the AST</li>
	  <li>Let's see that in action</li>
          <li>Alternatives</li>
	  <li>Conclusion</li>
        </ol>
      </section>
<section>
<h3>MetaProgramming is not recent</h3>
<hr />
<ul>
<li>Lisp ... in the 60s!</li>
<li>C with macros</li>
<br/>
<li>In JVM world, it has gained some interest:<ul>
<li>apt (limited features)</li>
<li>Emergence of new languages like Groovy or Clojure</li>
<li>or, of course, Scala</li>
</ul>
</li>
</ul>
</section>
<section>
<section>
<h3>A use case for this session</h3>
<hr/>
<div>Custom creation of scripts:</div>
<br/>
<ul>
<li>submitted by end users</li>
<li>executed later</li>
</ul>
</section>
<section>
<div>
<h3>Some constraints:</h3>
<hr/>
<ul>
<li>local development</li>
<li>API interaction constraints</li>
<li>Security/Sandboxing</li>
<li>DSL capabilities</li>
</ul>
</div>
</section>
</section>
<section>
<section>
<h3>How to create Compiler plugins</h3>
<hr/>
<p><small><a href="http://www.scala-lang.org/old/node/140">http://www.scala-lang.org/old/node/140</a></small></p>
</section>
<section>
<h3>When to write a plugin</h3>
<hr/>
<div style="text-align:left">Modify the compiler's behavior</div>
<div style="text-align:left">Should not be so frequent</div>
<br/>
<ul>
<li>add additional compile-time checks</li>
<li>add compile-time optimizations</li>
<li>rewrite Scala syntax into an entirely different, custom meaning
<ul><li>Dangerous =&gt; Looks like a good reason to give a try ;)</li></ul
</li>
</ul>
</section>
<section>
<h3>Steps to follow #1: xml definition</h3>
<hr/>
<ol>
<li>Create a java archive containing a scalac-plugin.xml</li>
<li>Define inside which class is your plugin entry point</li>
<li>Your code can be in the same jar (for small plugins) or as separated projects that you add in your project dependencies</li>
</ol>
<br/>
<pre><code>&lt;plugin&gt;
  &lt;name&gt;myPluginName&lt;/name&gt;
  &lt;classname&gt;my.package.path.MyPlugin&lt;/classname&gt;
&lt;/plugin&gt;</code></pre>
</section>
<section>
<h3>Steps to follow #2: Plugin class</h3>
<hr/>
<pre><code>
class MyPlugin(val global: Global) extends Plugin {
  val name = "myplugin"
  val description = "Provide a description"
  val components = List[PluginComponent](MyComponent)

</code></pre>
</section>
<section>
<h3>Steps to follow #3: Components</h3>
<hr/>
<pre><code>
private object MyComponent extends PluginComponent {
  val runsAfter = List[String]("refchecks");
  //override val runsBefore = List[String]("tailcalls");

  val phaseName = MyPlugin.this.name
  def newPhase(_prev: Phase) = new MyPhase(_prev)    

</code></pre>
</section>
<section>
<h3>Steps to follow #4: Phase defintion</h3>
<hr/>
<pre><code>
class MyPhase(prev: Phase) extends StdPhase(prev) {
  override def name = MyPlugin.this.name

  def apply(unit: CompilationUnit) {
    // Here starts the AST analysis

</code></pre>
</section>
<section>
<h3>How to use your plugin</h3>
<hr/>
<div style="text-align:left">
<ul>
<li>add scala-compiler.jar in the class path</li>
<li>pass the -Xplugin: or -Xpluginsdir argument</li>
</ul>
</div>
<br/>
<div style="text-align:left">
<div>You also can use sbt:</div>
<div><small><a href="http://www.scala-sbt.org/0.13.0/docs/Detailed-Topics/Compiler-Plugins.html">http://www.scala-sbt.org/0.13.0/docs/Detailed-Topics/Compiler-Plugins.html</a></small></div>
</div>
<br/>
<pre><code>autoCompilerPlugins := true

//addCompilerPlugin("org.scala-lang.plugins" % "continuations" % "2.10.3")

libraryDependencies +=
    compilerPlugin("org.scala-lang.plugins" % "continuations" % scalaVersion.value)

scalacOptions += "-P:continuations:enable"
</code></pre>
</section>
<section>
<h3>Useful Compiler Options</h3>
<hr/>
<div style="text-align:left">
<div>use scalac -X</div>
<br/>
<div>For example:</div>
<ul>
<li>-Xshow-phases</li>
<li>-Xplugin-list</li>
</ul>
</div>
</section>
<section>
<h3>Customize plugin with options</h3>
<hr/>
<div style="text-align:left">
<div>Adding your own command line options:</div>
<div>-P: followed by the name of the plugin.</div>
<br/>
<div>For example, -P:continuations:enable</div>
<br/>
</div>
<pre><code>override def processOptions(
  options: List[String],
  error: String =&gt; Unit)

override val optionsHelp: Option[String]
</code></pre>
</section>
</section>
<section>
<section>
<h3>How does the AST look like in Scala</h3>
<hr/>
<div><small><a href="http://docs.scala-lang.org/overviews/reflection/overview.html">http://docs.scala-lang.org/overviews/reflection/overview.html</a></small></div>
<br/>
<pre><code>
import scala.reflect.runtime.universe._

def tree = reify { // some code }.tree

show(tree)
showRaw(tree)

</code></pre>
</section>
<section>
<div>Trees trait</div>
<ul>
<li>Subclasses of TermTree which represent terms</li>
<li>Subclasses of TypTree which represent types</li>
<li>Subclasses of SymTree which introduce or reference definitions.</li>
</ul>
<div>Few examples</div>
ValDef, Expr,Apply, ClassDef, Block, Literal, Constant
</section>
</section>
<section>
<section>
<h3>Visiting the AST</h3>
<hr/>
Manual
Pattern Matching
</section>
<section>
<h3>Visiting with Traverser</h3>
<hr/>
<div>Traverser makes sure to visit every node in a given tree, in a breadth-first search.</div>

To use a Traverser, simply subclass Traverser and override method traverse. In doing so, you can simply provide custom logic to handle only the cases
 you're interested in. 
 
<pre><code>object traverser extends Traverser {
override def traverse(tree: Tree): Unit = tree match {
 case app @ Apply(fun, args) =&gt;
    //Some logic  
    //super.traverse(fun)
    //super.traverseTrees(args)
  case _ =&gt; super.traverse(tree)
  }
}</code></pre>
</section>
<section>
// Todo 2 use cases
// API recording
// System.exit call
We are in Scala so we must rely on type

<pre><code>for (global.Apply(fun, _) &lt;- unit.body) {
            fun.symbol match {
              case method: global.MethodSymbol =&gt;
                val classSymbol = method.owner
                val systemSymbol = global.findMemberFromRoot(global.TermName(classOf[System].getName))
                if ((method.nameString == "exit")
                  &amp;&amp; (classSymbol.tpe &lt;:&lt; systemSymbol.tpe))
                  unit.error(fun.pos, "System.exit forbidden")
              case _ =&gt; ()
</code></pre>
</section>    
</section>
<section>
<section>
<h3>Modifying the AST</h3>
<hr/>
Manual
NodeTree DSL
</section>
<section>
<h3>Tree Creation via reify/splice</h3>
<hr/>
Method reify simply takes a Scala expression as an argument, and produces that argument’s typed Tree representation as a result. cf previously

Code example

Splicing Trees

Code example

<pre><code>val x = reify(2)
reify(println(x.splice))</code></pre>
</section>
<section>
Other options
Transformer
TypingTransformer
</section>
<section>
<h3>Tree Creation via parse on ToolBoxes</h3>
<hr/>
Toolboxes can be used to typecheck, compile, and execute abstract syntax trees. 
A toolbox can also be used to parse a string into an AST.

Let’s see how parse deals with the println example from the previous section:
<pre><code>import scala.reflect.runtime.universe._
import scala.tools.reflect.ToolBox

val tb = runtimeMirror(getClass.getClassLoader).mkToolBox()

showRaw(tb.parse("println(2)"))</code></pre>


Typechecking with ToolBoxes

<pre><code>import scala.reflect.runtime.universe._
val tree = reify { "test".length }.tree

import scala.tools.reflect.ToolBox
val tb = runtimeMirror(getClass.getClassLoader).mkToolBox()

scala.tools.reflect.ToolBox[reflect.runtime.universe.type] = ...

val ttree = tb.typeCheck(tree)

ttree.tpe
ttree.symbol</code></pre>
</section>
<section>
<h3>Quasiquotes</h3>
<hr/>
<div>Liftable</div>
Liftable type class, which defines how values are transformed into trees when spliced in. 
</section>
</section>
      <section>
      <section>
        <h3>Let's see that in action</h3>
	</section>
      <section>
	<h3>Short Explanation</h3>
<hr/>
<ul>
<li>Presentation embedded inside a server</li>
<br/>
<li>The next eval page just sends code to the server - Ajax</li>
<br/>
<li>A scala Eval instance is spawned
<ul><li>Loads jars from a dedicated lib directory</li>
<li>Uses plugins from another dir</li>
<li>Evaluates the passed script</li>runs the script
<li>Hot reload</li>
</ul>
      </section>
	<!--section>
        <iframe style="display: inline-block; width: 100%; height: 720px; vertical-align: top;" src="index.html"></iframe> 
        </section-->
        <section>
         <div style="display: inline-block; width: 54%; height: 100%; vertical-align: top;">
     <div style="text-align:left; font-size:0.8em">input:</div>
      <div id="codecontent" style="font-size:0.7em; line-height:100%" ></div></div>
      <div style="display: inline-block; width: 44%; height: 100%; vertical-align: top; margin-left:10px">
	      <div style="text-align:left ; font-size:0.8em">output:</div>
	      <pre id="output" style="font-size:0.7em; background-color: #eee; height: 282px; width: 100%; -moz-box-sizing: border-box; margin-bottom:1.5%; margin-top:0; overflow:scroll; line-height: 90%"></pre>
	      <div style="text-align:left; margin-top:2%; font-size:0.8em">status:</div>
	 <pre id="status" style="font-size:0.7em; background-color: #eee; height: 282px; width: 100%; -moz-box-sizing: border-box; margin-top:0; overflow:scroll; line-height: 90%"></pre>
      </div>
      <div style="text-align:left"><input style="font-size:0.6em" type="submit" onClick="submitContent()" value="eval" /></div>
        </section>
	</section>
	<section>
	<section>
	<h3>Alternatives to compiler plugins</h3>
	<hr/>
<div>AST is definitely powerful</div>
<div>but complex and error prone</div>
<br/>
<div>Are there alternatives to solve the different use cases?</div>
</section>
<section>
<h3>Using AOP - traits</h3>
<hr/>
<div style="text-align:left">
<div>Replace visitor and enable some kinds of transformations</div>
<br/>
<div style="text-decoration: underline">Drawback:</div>
<ul><li>Done at runtime
<ul><li>=&gt; potential perf impact</li></ul>
</li></ul>
</section>
<section>
<h3>Using Macros</h3>
<hr/>
<div style="text-align:left">
<div>Simplify and focus the scope of AST manipulation</div>
<div>Interesting to apply some kinds of transformations:</div>
<div><ul><li>macro annotations to rewrite some part of the code</li></ul></div>
<br/>
<div style="text-decoration: underline">Drawback:</div>
<div>Macros have to be called or require some plumbing to be used</div>
<div>Remains close to AST manipulation</div>
</div>
</section>
<section>
<h3>Using JAAS as a sandboxing mechanism</h3>
<hr/>
<div style="text-align:left">
<div>Focus on security replacement</div>
<br/>
<div style="text-decoration: underline">Drawbacks:</div>
<ul><li>Not so easy replacement</li>
<li>Discovering at runtime</li>
<li>Granularity of the sandboxing</li>
</ul>
</section>
</section>
<section>
<section>
<h3>Conclusion</h3>
<hr/>
<div>Do Scala Compiler really matter?</div>
<div>Should we use them?</div>
</section>
<section>
<h3>Yes but ...</h3>
<hr/>
<ul>
<li>Use them carefully, when needed</li>
<br/>
<li>They are used in various scala parts:
<ul><li>macros and their using projects (like scala-async)</li>
<li>continuations</li>
</ul></li>
<br/>
<li>By default, consider alternatives</li>
<li>They can be very useful</li>
<br/>
<li>But be ready to dive into doc ...</li>
<li>Might impact compile time</li>
</ul>
</section>	
</section>
      <section>
      <h3>Further reading</h3>
      <ul>
	      <li><small><a href="http://www.scala-lang.org/old/node/140">http://www.scala-lang.org/old/node/140</a></small></li>
      <li><small><a href="http://docs.scala-lang.org/overviews/reflection/overview.html">http://docs.scala-lang.org/overviews/reflection/overview.html</a></small></li>
      <li><small><a href="http://lampsvn.epfl.ch/trac/scala/browser/scala/trunk/docs/examples/plugintemplate">http://lampsvn.epfl.ch/trac/scala/browser/scala/trunk/docs/examples/plugintemplate</a></small></li>
      <li><small><a href="http://www.scala-lang.org/files/archive/nightly/docs-master/compiler/#scala.tools.nsc.Global">http://www.scala-lang.org/files/archive/nightly/docs-master/compiler/#scala.tools.nsc.Global</a></small></li>
      <br/>
      <li><small><a href="http://docs.scala-lang.org/overviews/macros/toc.html">http://docs.scala-lang.org/overviews/macros/toc.html</a></small></li>
      <li><small><a href="http://scalamacros.org/">http://scalamacros.org/</a></small></li>
      </ul>
      </section>
      <section>
        <h3>Questions ?</h3>
      </section>
    <section>
    <h3>Thanks for your attention</h3>
    <hr/>
    <div style="text-align:left">
       <p><small>Based on Reveal.js created by <a href="http://hakim.se">Hakim El Hattab</a> / <a href="http://twitter.com/hakimel">@hakimel</a></small></p>
       <p><small>Powered by vim: <a href="http://www.vim.org/">http://www.vim.org/</a></small></p>
       <p><small>Special thanks @:<ul>
       <li>Eugene Burmako for his help and advice</li>
       <li>Mathieu Bruyen for his support</li></ul></small></p>
</div>
    </section>
    </div>
  </div>

  <script src="lib/js/head.min.js"></script>
  <script src="js/reveal.js"></script>
  
  <script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls : true,
      progress : true,
      history : true,
      center : true,

      theme : Reveal.getQueryHash().theme, // available themes are in /css/theme
      transition : Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

      //config.width
      width: 1200,
      height: 800,

      // Optional libraries used to extend on reveal.js
      dependencies : [ {
        src : 'lib/js/classList.js',
        condition : function() {
          return !document.body.classList;
        }
      }, {
        src : 'plugin/markdown/marked.js',
        condition : function() {
          return !!document.querySelector('[data-markdown]');
        }
      }, {
        src : 'plugin/markdown/markdown.js',
        condition : function() {
          return !!document.querySelector('[data-markdown]');
        }
      }, {
        src : 'plugin/highlight/highlight.js',
        async : true,
        callback : function() {
          hljs.initHighlightingOnLoad();
        }
      }, {
        src : 'plugin/zoom-js/zoom.js',
        async : true,
        condition : function() {
          return !!document.body.classList;
        }
      }, {
        src : 'plugin/notes/notes.js',
        async : true,
        condition : function() {
          return !!document.body.classList;
        }
      } ]
    });
   </script>
   
     <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>
      <script>
   var editor = ace.edit("codecontent");
   editor.setTheme("ace/theme/tomorrow");
   editor.getSession().setMode("ace/mode/scala");

   function submitContent() {
      var content='{content: '+JSON.stringify(editor.getValue())+'}'
      var xmlHttpReq = false;
      // Mozilla/Safari
      if (window.XMLHttpRequest) {
        xmlHttpReq = new XMLHttpRequest();
      }
      // IE
      else if (window.ActiveXObject) {
        xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
      }
  
      xmlHttpReq.onreadystatechange = function() {
      if (xmlHttpReq.readyState == 4) {
        var result = JSON.parse(xmlHttpReq.responseText);
        document.getElementById('output').innerHTML = result.output;
        document.getElementById('status').innerHTML = result.compilationStatus;
      }
    }     
    xmlHttpReq.open('POST', 'eval', true);
    xmlHttpReq.setRequestHeader('Content-Type', 'application/json');
    xmlHttpReq.send(content);
}
      </script>
</body>
</html>
